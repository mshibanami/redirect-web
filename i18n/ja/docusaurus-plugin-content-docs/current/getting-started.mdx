# はじめる

このページでは、Redirect Webアプリでルールを作成する際の一般的なユースケースについて説明します。

（ルール設定の詳細については、[ルール設定](./rule-settings)ページでも確認できます。）

## ケース1: 別のウェブサイトを開く

Twitterに夢中になっていて、うっかりTwitterを開いてしまったらInsight Timerで瞑想することにしたとします。そのためのルールを作成しましょう！

### ステップ1. 「Redirect From」を設定する

まず、アプリの「ルール編集」画面で「*Redirect From*」セクションを設定する必要があります。ターゲットは`https://twitter.com/`で始まるURLです。

この場合、[ワイルドカード](rule-settings?id=wildcard)モードで次のパターンを指定できます。

```
https://twitter.com/*
```

ワイルドカードモードでは、`*`は任意のもの（= 0文字以上）に一致することを意味します。

ただし、ちょっと待ってください。`twitter.com`は`x.com`に名前が変更されました。単純に`twitter.com`を`x.com`に置き換えることもできますが、新しい所有者がいつ気が変わって元に戻すかは誰にもわかりません。したがって、`twitter.com`と`x.com`の両方をターゲットにしましょう。

そのためには、ワイルドカードから[正規表現](rule-settings?id=regular-expression)に切り替えて、このパターンを設定します。

```
https://(twitter|x).com/.*
```

* `(twitter|x)`: `twitter`と`x`の両方をターゲットにします。（`|`は*パイプ*と呼ばれます。）
* `.*`: ワイルドカードの`*`と同じです。より具体的には、`.`は*任意の1文字*を意味し、`*`は*この記号の前の任意のものが0回以上繰り返される*ことを意味し、結果的に任意の文字列に一致します。

正規表現は少し複雑ですが、慣れると強力なツールになります。正規表現パターンがどのように機能するかを分析するためのプレイグラウンドとして、[RegExr](https://regexr.com)の使用をお勧めします。

> [!NOTE]
> 正規表現では、`(twitter|x).com`の`.`も*任意の文字*として扱われます。そのため、`(twitter|x).com/.*`は、例えば`twitter1com/`や`x_com/`にも一致します。
>
> これを避けるには、`(twitter|x)\.com/.*`に変更できます。`\`は特殊文字をエスケープするために使用されます。
>
> しかし、一般的なインターネット環境ではそのようなURLは存在しません。そのため、`.`を特殊文字のままにすることもできます。ルールはご自身の使用のためのものなので、ご自身の判断で実装してください。

### ステップ2: 「Redirect To」を設定する

単に次のようにURLを指定します。

```
https://insighttimer.com/saraauster/guided-meditations/calm
```

これで、Twitterにアクセスすると、Redirect Webが瞑想に誘ってくれるようになります！

**[⬇️ ルールをダウンロード](/rules/reduce-twitter-addiction.redirectweb)**

## ケース2: URLからクエリパラメータを削除する

`example.com`のURLに`source=twitter`というクエリパラメータがあり、匿名性を高めるためにこれを削除することにしたとします。

この場合、「**キャプチャグループ処理**」オプションが最も簡単な方法です。

* **Redirect From**: `https://example.com/*` (ワイルドカード)
* **Redirect To**: `$0`
* **キャプチャグループ処理**:
    * **グループ**: `$0`
    * **処理**: 出現箇所を置換
        * **ターゲット**: `&?source=[^&]*`
        * **置換**: *(なし)*
        * **テキストパターン**: 正規表現

**[⬇️ ルールをダウンロード](/rules/remove-parameters.redirectweb)**

このルールは次のように機能します。

```
https://example.com/?source=twitter
↪ https://example.com/?

https://example.com/?hello=world&source=twitter&foo=bar
↪ https://example.com/?hello=world&foo=bar
```

さらに多くのパラメータを削除したい場合は、処理を追加します。

## ケース3: URLにクエリパラメータを追加する

`example.com`というウェブサイトがあり、デフォルトではモバイルレイアウトが表示されますが、デスクトップレイアウトを好むとします。幸いなことに、このウェブサイトは、表示するレイアウトを指定するための`layout`クエリパラメータをサポートしています。`layout=desktop`を自動的に追加するルールを作成しましょう。

おそらく、次のように定義できると考えるかもしれません。

* **Redirect From**: `https://example.com/.*` (正規表現)
* **Redirect To**: `$0?layout=desktop`

`$0`はターゲットURLを参照します。`example.com/hello`にアクセスしようとすると、`example.com/hello?layout=desktop`にリダイレクトされます。この機能は*置換*と呼ばれます。

> [!TIP]
> ワイルドカードモードでも、内部的に正規表現に変換されるため、置換が利用可能です。

しかし、これらの設定にはいくつかの問題があります。

### 問題1: 無限ループ

現在の設定では、`https://example.com/.*`が`https://example.com/hello?layout=desktop`もターゲットにするため、無限リダイレクトループが発生します。

この場合、リダイレクトせずにアクセスできる除外URLパターンを、正規表現で次のように指定できます。

```
.*[&?]layout=[^&]*.*
```

* `.*`: 任意のものに一致
* `[&?]`: `&`または`?`のいずれかに一致
* `[^&]*`: `&`を除く任意のものに一致

### 問題2: 既存のパラメータを適切に処理できない

ターゲットURLにすでに`example.com/hello?theme=dark`のような他のクエリパラメータがある場合、宛先は`example.com/hello?theme=dark?layout=desktop`になります（URLに`?`が2つあります）が、パラメータは`&`でのみ結合できます。`?`は特殊文字としてパラメータの先頭にのみ許可されます。したがって、有効なパラメータとして扱われません。

この場合、設定を次のように変更します。

* **Redirect From**: `(https://example.com/[^?]*)(\?(.*))?`
* **Redirect To**: `$1?layout=desktop&$3`

段階的に見ていきましょう。

* `(https://example.com/[^?]*)`: `?`の前の文字までの部分に一致します。
    * `[^?]*`は`?`を除く任意のものに一致します。
    * これは`()`で囲まれているため、後で`$1`で参照できます。
* `(\?(.*))?`: `?`で始まる文字列に一致します。これはクエリパラメータを意味します。
    * これは、パターンの末尾にある`?`量指定子（*0回または1回一致*）によって空の文字列にも一致します。
    * 外側の`()`と内側の`()`は、後でそれぞれ`$2`と`$3`で参照できます。

[RegExr](https://regexr.com)が詳細を理解するのに役立つかもしれません。

> [!NOTE]
> RegExrでは、`/`を`\`でエスケープしないとエラーが表示されます。エスケープすることも可能ですが、Redirect WebはApple製の異なるエンジンを使用しているため、エスケープは必要ありません。

これは完璧な解決策ではありません。`example.com/hello`を`example.com/hello?layout=desktop&`にリダイレクトしてしまい、URLの末尾に不要な`&`が含まれてしまうからです。一般的には大きな問題ではありませんが、もし削除したい場合は、「*キャプチャグループ処理*」を使用できます。

結論として、これが最終的な出力です。

* **Redirect From**: `(https://example.com/[^?]*)((\?(.*))?)` (正規表現)
* **Redirect To**: `$1?layout=desktop$3`
* **除外URLパターン**: `.*[&?]layout=[^&]*.*` (正規表現)
* **キャプチャグループ処理**:
    * **グループ**: `$3`
    * **処理**: 出現箇所を置換
        * **ターゲット**: `\?(.*)`
        * **置換**: `&$1`

**[⬇️ ルールをダウンロード](/rules/add-parameters.redirectweb)**

これは単なる一例です。各問題を処理するために複数のルールを作成することもできます。その方がはるかにシンプルになる場合もあります。

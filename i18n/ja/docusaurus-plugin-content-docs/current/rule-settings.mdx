# ルール設定

このページでは、Redirect Webアプリの「ルール編集」画面にある各設定の詳細情報を提供します。

## オプション

### タイプ {#type}

**タイプ**オプションは、アプリがリダイレクトをどのように処理するかを制御するために指定します。以下から選択できます。

* **オリジナル** (デフォルト)
    * これは、従来からのWeb APIを使用してリダイレクトを制御します。さらに、フォールバックとして[Tabs API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs)を使用します。
        * Firefoxでは、[WebRequest API](https://developer.mozilla.org/docs/Mozilla/Add-ons/WebExtensions/API/webRequest)を使用してリダイレクトを処理します。
    * [リソースタイプ](#resource-types)と[リクエストメソッド](#request-methods)以外のすべてのオプションを使用できます。
    * これは「宣言型」タイプよりも遅く、余分なネットワークリクエストを引き起こす可能性があります。
* **DNR** (Safari向け実験的機能):
    * このタイプは、ソースURLのネットワークリクエストを開始しないため、オリジナルタイプよりもはるかに高速に動作します。
    * これにより、[リソースタイプ](#resource-types)と[リクエストメソッド](#request-methods)を指定できます。
    * ⚠️ [キャプチャグループ処理](#capturing-group-processing)や[除外URLパターン](#excluded-url-patterns)などの一部のオプションは、DNR APIでまだサポートされていないため使用できません。
    * ⚠️ Safariでは、現在、正規表現パターンにパイプ（`|`）を含めることはできません。[詳細](https://github.com/mshibanami/redirect-web/issues/44)
    * ⚠️ SafariのDNR APIにはまだいくつかの問題があるため、Safariではまだ実験的な機能と見なしています。既知のすべての問題のリストは[こちら](https://github.com/mshibanami/redirect-web/issues?q=state%3Aopen%20label%3ADNR%20label%3ASafari)で確認できます。

### リダイレクト元 {#redirect-from}

**リダイレクト元**オプションでは、リダイレクトしたいウェブページのURLパターンを指定できます。[ワイルドカード](#wildcard)または[正規表現](#regular-expression)のいずれかを選択できます。

例えば、ワイルドカードで`https://example.com/*`を指定すると、`https://example.com/`または`https://example.com/hello`に一致します。

> [!NOTE]
> リダイレクト先オプションでは、`$0`を使用して全体の一致を、`$1`、`$2`、...を使用して部分的な一致を参照できます。詳細はこのページの[URLパターン](#url-pattern)で確認してください。

#### リソースタイプ {#resource-types}

![サポートされているタイプ: DNR](https://img.shields.io/badge/Types-DNR-blue)

**リソースタイプ**オプションを使用すると、ルールが適用されるウェブ要求のカテゴリ（画像、JavaScript、スタイルシートなど）を指定できます。
例えば、`script`を設定すると、ウェブページによって読み込まれるJavaScriptファイルをリダイレクトできます。

現在、以下が利用可能です。
`main_frame`, `sub_frame`, `stylesheet`, `script`, `image`, `font`, `xmlhttprequest`, `ping`, `media`, `websocket`, `other`

デフォルト設定は`main_frame`で、これはタブに読み込まれるトップレベルのページです。

各リソースタイプの詳細については、[mdn web docs](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/declarativeNetRequest/ResourceType)で確認してください。

#### リクエストメソッド {#request-methods}

![サポートされているタイプ: DNR](https://img.shields.io/badge/Types-DNR-blue)

**リクエストメソッド**オプションを使用すると、ソースURLのターゲットHTTPメソッドを設定できます。

デフォルトではすべてのメソッドが設定されています。

各メソッドの詳細については、[mdn web docs](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods)で確認してください。

> [!WARNING]
> Safariでは、AppleのDNRタイプの実装が現在これを処理していないように見えるため、このオプションは利用できない場合があります。AppleにはFB14502272としてフィードバックを送信しました。

#### ターゲットブラウザ {#target-browsers}

![サポートされているプラットフォーム: macOS](https://img.shields.io/badge/Platforms-macOS-white)

**ターゲットブラウザ**オプションを使用すると、ルールを適用する、または適用しないブラウザを指定できます。

* 選択できるブラウザは2種類あります。
    * **デフォルトで選択できるブラウザ**: Safari、Chrome、Firefox、Edge、Opera、Arc、Brave、Vivaldiをデフォルトで選択できます。これは、SafariとSafari Technology Previewのような同じブラウザのバリアントを区別しません。
    * **ユーザー指定のブラウザ**: ポップオーバーの追加ボタンをタップすることで、Redirect Web拡張機能がインストールされているSafariまたはSafari Technology Preview以外の任意のブラウザを選択できます。
* **選択したものを除くすべて**チェックボックスは、選択したブラウザを除くすべてのブラウザをターゲットにします。

> [!WARNING]
> Redirect Webは、ブラウザが**Safari**か**Safari Technology Preview**かを区別できません。これは、アプリが拡張機能の親プロセスをチェックして検出しますが、これら2つのブラウザは同じ親プロセス（`/sbin/launchd`）を共有しているためです。

### リダイレクト先 {#redirect-to}

**リダイレクト先**オプションは、「リダイレクト元」オプションと一致したソースURLからリダイレクトしたい宛先URLを指定します。`$1`、`$2`、...または`$0`を使用してキャプチャグループ全体を置換することもできます。これらは宛先を動的に指定するのに役立ちます。詳細はこのページの[URLパターン](#url-pattern)で確認してください。

例えば、以下のルールを設定した場合：

* **リダイレクト元**: `https://google.com/*` (ワイルドカード)
* **リダイレクト先**: `https://apple.com/$1`

そして`https://google.com/hello`に一致した場合、宛先URLは`https://apple.com/hello`になります。

さらに、置換を行う前に`$1`、`$2`、...のテキストを変更できます。詳細については、[キャプチャグループ処理](#capturing-group-processing)セクションを確認してください。

> [!TIP]
> アプリを開くためのカスタムURLスキームを指定できます。これらはディープリンクをサポートするアプリの例です。
>
> * Figma: `figma://file/Your_Figma_ID`
> * Firefox: `firefox://open-url?url=https://example.com/hello`
> * Google Chrome: `googlechromes://example.com`
> * Microsoft Edge: `microsoft-edge://example.com`
> * Notion: `notion://www.notion.so/Your_Note_ID`
> * Slack: `slack://open`

#### アプリケーション {#application}

![サポートされているタイプ: オリジナル](https://img.shields.io/badge/Types-Original-blue) ![サポートされているプラットフォーム: macOS](https://img.shields.io/badge/Platforms-macOS-white)

宛先URLを開きたいアプリを指定したい場合は、**アプリケーション**コンボボックスを使用します。これはmacOSでのみ利用可能です。

> [!WARNING]
> [App Sandbox](https://developer.apple.com/documentation/security/app_sandbox)をサポートするアプリのみを開くことができます。また、アプリが開きたいURLのオープンをサポートしていることを確認してください。

### キャプチャグループ処理 {#capturing-group-processing}

![サポートされているタイプ: オリジナル](https://img.shields.io/badge/Types-Original-blue)

**キャプチャグループ処理**オプションを使用すると、「リダイレクト先」オプションで`$1`、`$2`...を使用して置換できるキャプチャグループをどのように処理するかを指定できます。

キャプチャグループを作成する方法は次のとおりです。

* **ワイルドカード**: `*`と`?`に一致するテキストは自動的にキャプチャされます。
* **正規表現**: パターン内の`()`内の部分に一致するテキストがキャプチャされます。

以下の処理を1つ以上選択できます。

* **URLエンコード/デコード**: これは、キャプチャグループに[パーセントエンコーディング](https://ja.wikipedia.org/wiki/%E3%83%91%E3%83%BC%E3%82%BB%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%82%B3%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0)またはデコードを適用します。例えば、`https://example.com/hello`をエンコードすると、`https%3A%2F%2Fexample.com%2Fhello`に変換されます。デコードはその逆の動作をします。
* **Base64エンコード/デコード**: これは、テキストを[Base64](https://ja.wikipedia.org/wiki/Base64)にデコード/エンコードします。例えば、`hello`を`aGVsbG8=`にエンコードし、`hello`にデコードし直すことができます。
* **出現箇所の置換**: これは、**ターゲット**に一致するグループ内の1つ以上の文字を**置換**で置き換えます。例えば、*グループ*が`hello`で、*ターゲット*が`l`、*置換*が`y`の場合、`heyyo`に修正されます。

> [!NOTE]
> これは各キャプチャグループを処理するためのものであり、[除外URLパターン](#excluded-url-patterns)によって除外されるURLには影響しません。例えば、次のルールがあるとします。
>
> * **リダイレクト元**: `https://example.com/(hello.*)`
> * **キャプチャグループ処理**:
>     * グループ: `$1`
>     * ターゲット: `.*` (正規表現)
>     * 置換: `hello`
> * **除外URLパターン**: `https://example.com/hello`
>
> この場合、`https://example.com/hello_world`は除外されず、`https://example.com/hello`は除外されます。

### 除外URLパターン {#excluded-url-patterns}

![サポートされているタイプ: オリジナル](https://img.shields.io/badge/Types-Original-blue)

**除外URLパターン**オプションを使用すると、リダイレクトされないURLを指定できます。これは、リダイレクトループを回避したり、ウェブサイトの特定の部分がリダイレクトされないようにしたりするのに役立ちます。

除外URLパターンは、正規表現またはワイルドカードパターンタイプを使用して指定できます。

### 例 {#examples}

**例**オプションを使用すると、サンプルURLを提供することでリダイレクトルールをテストできます。サンプルURLを追加することで、実際に適用する前にルールが期待どおりに機能するかどうかを確認できます。

### コメント {#comments}

**コメント**オプションを使用すると、リダイレクトルールに関するメモやコメントを追加できます。これは、特定のルールを作成した理由を記録したり、ルールを閲覧する可能性のある他のユーザーにコンテキストを提供したりするのに役立ちます。

コメントは以下の形式で記述できます。

* **プレーンテキスト** (デフォルト): フォーマットなしのシンプルなテキスト。
* **Markdown**: [GitHubのMarkdown構文](https://docs.github.com/en/get-started/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax)を使用できます。GFMがサポートしていない一部の拡張機能も含まれます。例えば、見出し、リスト、リンクなどを作成できます。
* **AsciiDoc**: [AsciiDoc構文](https://asciidoc.org/)を使用してコメントをフォーマットできます。

## URLパターン {#url-pattern}

**URLパターン**は、「リダイレクト元」、「除外URLパターン」、および「キャプチャグループ処理」オプションでURLを照合するために使用されます。これらを指定するには、**ワイルドカード**または**正規表現**のいずれかを選択できます。

### ワイルドカード {#url-pattern-wildcard}

**ワイルドカード**は、`*`（何でも一致）と`?`（任意の1文字に一致）をワイルドカードとして使用できるシンプルなパターンタイプです。以下にいくつかの例を示します。

* `https://example.com/hello`に一致させるには、`https://example.com/*`を使用できます。これは`https://example.com/`の後の任意の文字列に一致します。
* `https://example.com/search?q=hello`に一致させるには、`https://example.com/search?q=*`を使用できます。これは`q`パラメーターの任意の値に一致します。
* `blog`という単語を含む任意のURLに一致させるには、`*blog*`を使用できます。

ワイルドカードでも置換を使用できます。つまり、`$1`、`$2`などを使用して一致したURLの一部を参照できます。例えば、`https://example.com/*-world-*`を使用し、URLが`https://example.com/hello-world-goodbye`の場合、`$1`は「hello」、`$2`は「goodbye」になります。`$0`は一致したURL全体を参照するためにも利用できます。

> [!NOTE]
> 置換は正規表現の機能ですが、Redirect Webは内部的にワイルドカードを正規表現に変換するため、ワイルドカードでも使用できます。

### 正規表現 {#url-pattern-regular-expression}

**正規表現**（Regex）は、テキスト内のパターンを照合するための強力なツールであり、プログラミングでも広く使用されています。これは、一連の文字列に一致する特定のパターンを定義することを可能にします。以下にいくつかの例を示します。

- `https://example.com/hello`に一致させるには、`https://example.com/.*`を使用できます。これは`https://example.com/`の後の任意の文字列に一致します。
- `https://example.com/search?q=hello`に一致させるには、`https://example.com/search\?q=(.*)`を使用できます。これは`q`パラメーターの値を照合し、キャプチャグループに格納します。その後、「リダイレクト先」オプションで`$1`を使用して参照できます。
- `blog`という単語を含む任意のURLに一致させるには、`.*blog.*`を使用できます。

「リダイレクト先」または「置換」で`$1`、`$2`、...を使用してキャプチャグループを参照したり、`$0`を使用して全体の一致を参照したりできます。

Redirect Webは[Appleの正規表現エンジン](https://developer.apple.com/documentation/foundation/nsregularexpression#1661042)を搭載しています。

正規表現の構文に関する詳細情報は、[RegExr](https://regexr.com/)などのリソースで確認できます。